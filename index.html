<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shio's Progress Tracker</title>
    <!-- Using Tailwind CSS for fast and beautiful styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import 3D library (Three.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Importing Tone.js for custom chill music -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Import new fonts (Fun, Bold, Rounded) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Define our custom lofi color palette */
        :root {
            --dark-green: #344E41;
            /* Made the accent semi-transparent for glass effect */
            --dark-accent: rgba(58, 90, 64, 0.75); 
            --sage-green: #A3B18A;
            --beige-text: #DAD7CD;
            --light-beige: #f5f3ef;
        }

        /* Using the new fonts */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif; /* Calming, rounded font for the body */
            background-color: var(--dark-green);
            color: var(--beige-text);
            /* Added perspective for 3D tilt effect */
            perspective: 1000px; 
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Fredoka One', cursive; /* Fun, "bold" font for headers */
            /* Added text shadow */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* 3D Canvas Background */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Placed behind everything */
        }

        /* Custom scrollbar para sa aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--dark-green);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--sage-green);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #b7c49f;
        }

        /* Override Tailwind colors to use our custom palette */
        .bg-dark-green { background-color: var(--dark-green); }
        .bg-dark-accent { background-color: var(--dark-accent); }
        .bg-sage-green { background-color: var(--sage-green); }
        .text-beige-text { color: var(--beige-text); }
        .text-dark-green { color: var(--dark-green); }
        
        /* The "Glass" Card Effect */
        .card {
            background-color: var(--dark-accent);
            border-radius: 0.75rem; /* 12px */
            padding: 1.5rem; /* 24px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            
            /* This is the magic for "frosted glass" */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(163, 177, 138, 0.2); /* Faint sage border */
            
            /* Added transition for smooth 3D tilt */
            transition: transform 0.1s ease-out;
        }
        
        .btn {
            background-color: var(--sage-green);
            color: var(--dark-green);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s ease-in-out;
            font-family: 'M PLUS Rounded 1c', sans-serif; /* Changed the font */
            font-weight: 700; /* Bolder */
        }
        .btn:hover {
            opacity: 0.85;
        } /* <-- Ito yung kulang na brace! */
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .input-field {
            background-color: var(--beige-text);
            color: var(--dark-green);
            border: 2px solid transparent;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            font-family: 'M PLUS Rounded 1c', sans-serif; /* Changed the font */
        }
        .input-field::placeholder {
            color: #7d7c78;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--sage-green);
        }

        .progress-bar-bg {
            background-color: var(--dark-green);
            border-radius: 9999px;
            height: 1rem; /* 16px */
            overflow: hidden;
            border: 1px solid var(--sage-green);
        }
        .progress-bar-inner {
            background-color: var(--sage-green);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2); /* More transparent for items */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        .task-item:hover {
            background-color: rgba(0,0,0,0.3);
        }
        
        .badge {
            font-size: 0.75rem; /* 12px */
            font-weight: 600; /* Bolder */
            padding: 0.25rem 0.75rem; /* Wider */
            border-radius: 9999px;
            text-transform: uppercase;
            font-family: 'M PLUS Rounded 1c', sans-serif; /* Changed the font */
        }

        /* Style for the music button */
        .music-btn {
            background-color: var(--dark-accent);
            color: var(--sage-green);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--sage-green);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }
        .music-btn:hover {
            background-color: var(--sage-green);
            color: var(--dark-green);
        }
    </style>
</head>
<body class="bg-dark-green text-beige-text p-4 md:p-8">

    <!-- 3D Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <div class="max-w-7xl mx-auto relative z-10"> <!-- Added relative z-10 -->
        
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-5xl font-bold text-beige-text flex items-center">
                    <span class="mr-3">üçÉ</span> Shio's Progress Tracker
                </h1>
                <p class="text-lg text-sage-green mt-1">My calming space for productivity.</p>
            </div>
            <!-- Play Music button -->
            <button id="music-toggle" class="music-btn">Play Music üéß</button>
        </header>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Trackers & Focus -->
            <div class="lg:col-span-1 space-y-6">

                <!-- REMOVED: The YouTube player card has been removed -->
                
                <!-- Daily Encoding Tracker -->
                <div class="card">
                    <h2 class="text-3xl font-semibold text-sage-green mb-4">Daily Encoding Tracker ‚ö°</h2>
                    <div class="text-center mb-4">
                        <span id="encoding-count" class="text-6xl font-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">0</span>
                        <span class="text-2xl text-sage-green"> / </span>
                        <input type="number" id="encoding-goal" value="350" class="bg-transparent text-6xl font-bold w-36 text-beige-text outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="progress-bar-bg mb-4">
                        <div id="encoding-progress" class="progress-bar-inner" style="width: 0%;"></div>
                    </div>
                    <p id="encoding-message" class="text-center text-sm text-sage-green mb-4 h-5"></p>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <button onclick="addEncoding(1)" class="btn text-sm py-3">+1 üå±</button>
                        <button onclick="addEncoding(10)" class="btn text-sm py-3">+10 üåø</button>
                        <button onclick="addEncoding(50)" class="btn text-sm py-3">+50 üå≥</button>
                    </div>
                    
                    <!-- Manual Set & Reset -->
                    <div class="flex gap-2">
                         <input type="number" id="manual-set-value" placeholder="Set count..." class="input-field [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                        <button onclick="setEncoding()" class="btn">Set</button>
                        <button onclick="resetEncoding()" class="btn bg-red-400 text-red-900 hover:opacity-80">Reset ‚ôªÔ∏è</button>
                    </div>
                </div>

                <!-- Capstone Overall Progress -->
                <div class="card">
                    <h2 class="text-3xl font-semibold text-sage-green mb-4">Capstone Progress üìö</h2>
                    <div class="text-center mb-3">
                        <span id="capstone-progress-text" class="text-xl">0 / 0 tasks complete</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div id="capstone-progress-bar" class="progress-bar-inner" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Focus & Reflection -->
                <div class="card">
                    <h2 class="text-3xl font-semibold text-sage-green mb-4">Focus & Reflection üßò</h2>
                    <label for="focus-text" class="text-sm font-medium text-sage-green">Focus of the Day</label>
                    <textarea id="focus-text" rows="3" class="input-field mb-4 mt-1" placeholder="What's your main focus for today?"></textarea>
                    
                    <label for="reflection-text" class="text-sm font-medium text-sage-green">Daily Reflection</label>
                    <textarea id="reflection-text" rows="4" class="input-field mt-1" placeholder="What did you learn? What went well?"></textarea>
                
                    <!-- Gemini Feature: Analyze Reflection -->
                    <button id="analyze-reflection-btn" class="btn w-full mt-4">‚ú® Analyze My Day</button>
                    <p id="analysis-output" class="text-sm text-sage-green mt-3 h-12"></p>
                </div>

            </div>

            <!-- Right Column: Capstone Task List -->
            <div class="lg:col-span-2 card">
                <h2 class="text-3xl font-semibold text-sage-green mb-4">Capstone Task List üìù</h2>
                
                <!-- Add Task Form -->
                <form id="add-task-form" class="grid md:grid-cols-3 gap-4 mb-6">
                    <input type="text" id="task-name" placeholder="Task Name" class="input-field md:col-span-2" required>
                    
                    <select id="task-status" class="input-field">
                        <option value="Not Started">Not Started</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Done">Done</option>
                    </select>

                    <input type="text" id="task-category" placeholder="Category (e.g., Research)" class="input-field md:col-span-2">
                    
                    <button type="submit" class="btn md:col-span-1">Add Task üìå</button>
                </form>

                <!-- Clear Done Button -->
                <div class="flex justify-end mb-4 -mt-2">
                    <button onclick="clearDoneTasks()" class="text-sm text-sage-green hover:text-beige-text transition-colors duration-200">
                        Clear Done Tasks üßπ
                    </button>
                </div>

                <!-- Task List Container -->
                <div id="task-list" class="max-h-[600px] overflow-y-auto pr-2">
                    <!-- Tasks will be inserted here by JavaScript -->
                </div>
            </div>

        </div>
    </div>

            <script>
        // --- 3D Background Setup (Three.js) ---
        let scene, camera, renderer, particles;

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Create particles (dust motes)
            const particleCount = 2000;
            const positions = new Float32Array(particleCount * 3);
            for (let i = 0; i < particleCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 10;
            }
            const particleGeometry = new THREE.BufferGeometry();
            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const particleMaterial = new THREE.PointsMaterial({
                color: 0xA3B18A, // Sage green particles
                size: 0.02,
                transparent: true,
                opacity: 0.7
            });
            particles = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particles);

            // Simple ambient light
            const ambientLight = new THREE.AmbientLight(0xDAD7CD, 0.5); // Beige light
            scene.add(ambientLight);

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate3D();
        }

        function animate3D() {
            requestAnimationFrame(animate3D);

            // Animate particles
            particles.rotation.x += 0.0001;
            particles.rotation.y += 0.0003;

            renderer.render(scene, camera);
        }

        // --- Lofi Music Setup (Tone.js) ---
        let lofiSynth, lofiMelody, musicPlaying = false;
        const musicToggleBtn = document.getElementById('music-toggle');

        function initMusic() {
            // More "chill" effects: Reverb and a simple Delay
            const reverb = new Tone.Reverb(1.5).toDestination();
            const delay = new Tone.FeedbackDelay("8n", 0.4).connect(reverb);

            // A softer synth (FMSynth) instead of the harsh "fatsawtooth"
            lofiSynth = new Tone.FMSynth({
                harmonicity: 1.5,
                modulationIndex: 1.2,
                oscillator: { type: 'sine' },
                envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 0.8 },
                modulation: { type: 'square' },
                modulationEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 0.7 }
            }).connect(delay);
            
            // A much more soothing, repetitive lofi-style melody (Cmaj7, Fmaj7)
            const melody = [
                'C4', null, 'E4', 'G4', 'B4', null, 'G4', 'E4',
                'F3', null, 'A3', 'C4', 'E4', null, 'C4', 'A3'
            ];

            lofiMelody = new Tone.Sequence((time, note) => {
                if (note) {
                    lofiSynth.triggerAttackRelease(note, '8n', time);
                }
            }, melody, '8n'); // 8n = eighth note, makes it flow better

            // Set transport settings
            Tone.Transport.bpm.value = 80; // Slow, chill BPM
            Tone.Transport.loop = true;
            Tone.Transport.loopEnd = '4m'; // Loop every 4 measures
            
            lofiMelody.start(0);
        }

        musicToggleBtn.addEventListener('click', async () => {
            if (!musicPlaying) {
                // Start music
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                }
                if (!lofiSynth) {
                    initMusic(); // Initialize only when first clicked
                }
                Tone.Transport.start();
                musicToggleBtn.textContent = 'Mute üéµ';
                musicPlaying = true;
            } else {
                // Stop music
                Tone.Transport.stop();
                musicToggleBtn.textContent = 'Play Music üéß';
                musicPlaying = false;
            }
        });


        // --- 3D Card Tilt Effect ---
        const cards = document.querySelectorAll('.card');
        const tiltAngle = 5; // How much the card tilts (in degrees)

        document.body.addEventListener('mousemove', (e) => {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            // Calculate mouse position relative to center (-1 to 1)
            const mouseX = (e.clientX - centerX) / centerX;
            const mouseY = (e.clientY - centerY) / centerY;

            cards.forEach(card => {
                card.style.transform = `
                    rotateY(${mouseX * tiltAngle}deg) 
                    rotateX(${-mouseY * tiltAngle}deg)
                `;
            });
        });


        // --- Original Dashboard Logic (nasa ibaba) ---
        
        // --- State Variables ---
        let encodingCount = 0;
        let encodingGoal = 350;
        let capstoneTasks = []; // Array of {id, name, status, category}

        // --- DOM Elements ---
        const countEl = document.getElementById('encoding-count');
        const goalEl = document.getElementById('encoding-goal');
        const progressEl = document.getElementById('encoding-progress');
        const messageEl = document.getElementById('encoding-message');
        
        const taskForm = document.getElementById('add-task-form');
        const taskNameInput = document.getElementById('task-name');
        const taskStatusInput = document.getElementById('task-status');
        const taskCategoryInput = document.getElementById('task-category');
        const taskListEl = document.getElementById('task-list');

        const capstoneProgressText = document.getElementById('capstone-progress-text');
        const capstoneProgressBar = document.getElementById('capstone-progress-bar');
        
        const focusTextEl = document.getElementById('focus-text');
        const reflectionTextEl = document.getElementById('reflection-text');
        const manualSetValueEl = document.getElementById('manual-set-value');

        // Gemini Feature Elements
        const analyzeReflectionBtn = document.getElementById('analyze-reflection-btn');
        const analysisOutputEl = document.getElementById('analysis-output');

        // --- Event Listeners ---
        
        // Load all data when the page opens
        document.addEventListener('DOMContentLoaded', () => {
            init3D(); // Start the 3D background
            loadData();
            updateEncodingUI();
            renderTasks();
            
            // Auto-save for text areas
            focusTextEl.addEventListener('input', saveData);
            reflectionTextEl.addEventListener('input', saveData);
            goalEl.addEventListener('input', () => {
                encodingGoal = parseInt(goalEl.value) || 350;
                updateEncodingUI();
                saveData();
            });
            
            // Listener for "Add Task" form
            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addCapstoneTaskFromForm();
            });

            // Gemini Feature Listener
            analyzeReflectionBtn.addEventListener('click', handleAnalyzeReflection);
        });

        // --- Encoding Tracker Functions ---

        function addEncoding(num) {
            encodingCount += num;
            updateEncodingUI();
            saveData();
        }

        function setEncoding() {
            encodingCount = parseInt(manualSetValueEl.value) || 0;
            manualSetValueEl.value = ''; // Clear input after setting
            updateEncodingUI();
            saveData();
        }

        function resetEncoding() {
            encodingCount = 0;
            updateEncodingUI();
            saveData();
        }

        function updateEncodingUI() {
            encodingGoal = parseInt(goalEl.value) || 350;
            countEl.textContent = encodingCount;
            
            let percentage = 0;
            if (encodingGoal > 0) {
                percentage = (encodingCount / encodingGoal) * 100;
            }
            if (percentage > 100) percentage = 100;
            if (percentage < 0) percentage = 0;
            
            progressEl.style.width = `${percentage}%`;

            // Provide feedback message
            if (encodingCount === 0) {
                messageEl.textContent = "Let's get started! ‚ú®";
            } else if (encodingCount >= encodingGoal) {
                messageEl.textContent = "Quota reached! Great job! üéâ";
            } else if (encodingCount > encodingGoal / 2) {
                messageEl.textContent = "You're more than halfway there! üëè";
            } else {
                 messageEl.textContent = "Keep going! üí™";
            }
        }

        // --- Capstone Task Functions ---
        
        function addCapstoneTaskFromForm() {
            const name = taskNameInput.value.trim();
            const status = taskStatusInput.value;
            const category = taskCategoryInput.value.trim();

            if (!name) {
                return; // Don't add if there's no task name
            }

            addCapstoneTask(name, status, category || 'General');
            
            // Clear the inputs
            taskNameInput.value = '';
            taskCategoryInput.value = '';
            taskStatusInput.value = 'Not Started';
        }

        function addCapstoneTask(name, status, category) {
            const newTask = {
                id: Date.now(), // Simple unique ID
                name: name,
                status: status,
                category: category
            };

            capstoneTasks.push(newTask);
            renderTasks();
            saveData();
        }
        
        function deleteCapstoneTask(id) {
            // Filter out the task with the matching ID
            capstoneTasks = capstoneTasks.filter(task => task.id !== id);
            renderTasks();
            saveData();
        }

        function clearDoneTasks() {
            // Filter out all tasks with "Done" status
            capstoneTasks = capstoneTasks.filter(task => task.status !== 'Done');
            renderTasks();
            saveData();
        }
        
        function toggleTaskStatus(id) {
            const task = capstoneTasks.find(task => task.id === id);
            if (task) {
                if (task.status === 'Not Started') {
                    task.status = 'In Progress';
                } else if (task.status === 'In Progress') {
                    task.status = 'Done';
                } else {
                    task.status = 'Not Started';
                }
            }
            renderTasks();
            saveData();
        }
        
        function renderTasks() {
            // Clear the list first
            taskListEl.innerHTML = '';

            if (capstoneTasks.length === 0) {
                taskListEl.innerHTML = `<p class="text-center text-sage-green p-4">No tasks yet. Add one! üçÉ</p>`;
            } else {
                capstoneTasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'task-item';
                    
                    // Change color based on status
                    let statusColor = '';
                    if (task.status === 'Done') {
                        statusColor = 'bg-green-300 text-green-800';
                    } else if (task.status === 'In Progress') {
                        statusColor = 'bg-yellow-300 text-yellow-800';
                    } else {
                        statusColor = 'bg-gray-300 text-gray-800';
                    }
                    
                    // Strikethrough if "Done"
                    const taskNameClass = task.status === 'Done' ? 'line-through text-gray-400' : '';

                    taskEl.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold truncate ${taskNameClass}" title="${task.name}">${task.name}</p>
                            <p class="text-sm text-sage-green">${task.category}</p>
                        </div>
                        <div class="flex items-center space-x-3 ml-4">
                            <!-- Gemini Feature: Generate Subtasks Button -->
                            <button onclick="generateSubtasks(${task.id}, '${task.name}')" class="text-purple-300 hover:text-purple-200 text-xl" title="‚ú® Generate Sub-tasks">‚ú®</button>
                            <span class="badge ${statusColor} cursor-pointer" onclick="toggleTaskStatus(${task.id})">${task.status}</span>
                            <button onclick="deleteCapstoneTask(${task.id})" class="text-red-400 hover:text-red-300 text-xl" title="Delete Task">&times;</button>
                        </div>
                    `;
                    taskListEl.appendChild(taskEl);
                });
            }
            
            // Update the overall progress bar
            updateOverallProgress();
        }
        
        function updateOverallProgress() {
            const totalTasks = capstoneTasks.length;
            const doneTasks = capstoneTasks.filter(task => task.status === 'Done').length;
            
            capstoneProgressText.textContent = `${doneTasks} / ${totalTasks} tasks complete`;
            
            let percentage = 0;
            if (totalTasks > 0) {
                percentage = (doneTasks / totalTasks) * 100;
            }
            
            capstoneProgressBar.style.width = `${percentage}%`;
        }

        // --- Data Persistence (localStorage) ---

        function saveData() {
            // Save all state to localStorage
            localStorage.setItem('encodingCount', encodingCount.toString());
            localStorage.setItem('encodingGoal', encodingGoal.toString());
            localStorage.setItem('capstoneTasks', JSON.stringify(capstoneTasks));
            localStorage.setItem('focusText', focusTextEl.value);
            localStorage.setItem('reflectionText', reflectionTextEl.value);
            // console.log("Data saved!"); // For debugging
        }
        
        function loadData() {
            // Load all data from localStorage
            encodingCount = parseInt(localStorage.getItem('encodingCount')) || 0;
            encodingGoal = parseInt(localStorage.getItem('encodingGoal')) || 350;
            capstoneTasks = JSON.parse(localStorage.getItem('capstoneTasks')) || [];
            focusTextEl.value = localStorage.getItem('focusText') || '';
            reflectionTextEl.value = localStorage.getItem('reflectionText') || '';
            goalEl.value = encodingGoal;
            
            // console.log("Data loaded!"); // For debugging
        }

        // --- ‚ú®‚ú® GEMINI API FEATURES ‚ú®‚ú® ---

        /**
         * Generic function to call the Gemini API with exponential backoff.
         * @param {string} systemPrompt - The system instruction for the model.
         * @param {string} userQuery - The user's prompt.
         * @returns {Promise<string>} - The generated text response.
         */
        async function callGeminiAPI(systemPrompt, userQuery) {
            const apiKey = ""; // Leave this as-is, Canvas will handle it
            const apiUrl = `https://generativanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let response;
            let retries = 0;
            const maxRetries = 5;

            while (retries < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            throw new Error("Invalid response structure from Gemini API.");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, wait and retry
                        const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retries++;
                    } else {
                        // Other client-side error
                        const errorResult = await response.json();
                        console.error("Gemini API Error:", errorResult);
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                    if (retries >= maxRetries - 1) {
                        throw error;
                    }
                    retries++;
                }
            }
            throw new Error("Max retries reached. Failed to call Gemini API.");
        }

        /**
         * Feature 1: Generate Sub-tasks for a Capstone Task
         */
        async function generateSubtasks(taskId, taskName) {
            const task = capstoneTasks.find(t => t.id === taskId);
            if (!task) return;

            // Simple loading state (you can get fancier)
            const originalCategory = task.category;
            task.category = "Generating sub-tasks... ‚ú®";
            renderTasks();

            const systemPrompt = "You are a helpful project management assistant. You break down complex tasks into 3-5 simple, actionable sub-tasks. Respond with *only* the sub-tasks, separated by newlines. Do not add any preamble like 'Here are the sub-tasks:'.";
            const userQuery = `Break down this capstone project task: "${taskName}"`;

            try {
                const generatedText = await callGeminiAPI(systemPrompt, userQuery);
                const subtasks = generatedText.split('\n').filter(t => t.trim() !== '');

                // Add subtasks to the list
                subtasks.forEach(subtaskName => {
                    // Adds the new task with a clear "sub-task" category
                    addCapstoneTask(`- ${subtaskName.trim()}`, 'Not Started', `Sub-task of '${taskName}'`);
                });
                
                // Restore original task's category
                task.category = originalCategory;
                renderTasks();

            } catch (error) {
                console.error("Failed to generate subtasks:", error);
                task.category = "Error generating sub-tasks.";
                renderTasks();
                // Revert after a delay
                setTimeout(() => {
                    task.category = originalCategory;
                    renderTasks();
                }, 3000);
            }
        }

        /**
         * Feature 2: Analyze Daily Focus & Reflection
         */
        async function handleAnalyzeReflection() {
            const focusText = focusTextEl.value.trim();
            const reflectionText = reflectionTextEl.value.trim();

            if (!focusText && !reflectionText) {
                analysisOutputEl.textContent = "Please write a focus or reflection first.";
                return;
            }

            // Set loading state
            analyzeReflectionBtn.disabled = true;
            analyzeReflectionBtn.textContent = "Analyzing... ‚ú®";
            analysisOutputEl.textContent = "";

            const systemPrompt = "You are a kind, insightful personal coach. You read a user's daily focus and reflection. Respond with one short, encouraging, and insightful sentence (1-2 lines max) that acknowledges their effort or provides a gentle perspective. Be warm and supportive. Do not use quotes. Respond in English.";
            const userQuery = `My focus was: "${focusText}". My reflection is: "${reflectionText}". What's your insight?`;

            try {
                const generatedText = await callGeminiAPI(systemPrompt, userQuery);
                analysisOutputEl.textContent = generatedText;
            } catch (error) {
                console.error("Failed to analyze reflection:", error);
                analysisOutputEl.textContent = "Sorry, couldn't get an analysis right now.";
            } finally {
                // Reset button
                analyzeReflectionBtn.disabled = false;
                analyzeReflectionBtn.textContent = "‚ú® Analyze My Day";
            }
        }

    </script>
</body>
</html>
